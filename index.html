<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SmartList - Assistant Courses</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f3f4f6;
            color: #111827;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            background: #e5e7eb;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        
        .nav-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:active {
            background: #2563eb;
        }
        
        .btn-success {
            background: #22c55e;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-icon {
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        /* Main content */
        .main {
            padding: 1rem;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        /* Input */
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* Items list */
        .item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .item.completed {
            opacity: 0.6;
        }
        
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .checkbox.checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        .item-name {
            flex: 1;
        }
        
        .item-name.completed {
            text-decoration: line-through;
        }
        
        /* Categories */
        .category-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin: 1rem 0 0.5rem 0;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        /* Dark mode */
        body.dark {
            background: #111827;
            color: #f9fafb;
        }
        
        body.dark .header,
        body.dark .card {
            background: #1f2937;
        }
        
        body.dark .item {
            background: #374151;
        }
        
        body.dark .nav-btn {
            background: #374151;
            color: #f9fafb;
        }
        
        body.dark .input {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        
        /* Splash screen */
        .splash {
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom right, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .splash-content {
            text-align: center;
            color: white;
        }
        
        .splash-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-10px); }
            50% { transform: translateY(0); }
        }
        
        /* Icons */
        .icon {
            width: 24px;
            height: 24px;
        }
        
        .icon-lg {
            width: 48px;
            height: 48px;
        }
        
        /* Utilities */
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
        }
        
        body.dark .modal-content {
            background: #1f2937;
        }
        
        /* Voice indicator */
        .voice-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
            z-index: 100;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .theme-picker {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .theme-option {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
        }
        
        .theme-option.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .theme-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
        }
        
        /* Responsive */
        @media (max-width: 640px) {
            .header-top {
                flex-wrap: wrap;
            }
            
            .nav {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDemoKey-ReplaceWithYourOwnKey",
            authDomain: "smartlist-demo.firebaseapp.com",
            databaseURL: "https://smartlist-demo-default-rtdb.firebaseio.com",
            projectId: "smartlist-demo",
            storageBucket: "smartlist-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        let firebaseApp = null;
        let database = null;
        let currentListRef = null;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialis√©');
        } catch (error) {
            console.warn('Firebase non disponible (mode d√©mo):', error.message);
        }

        // App state
        const state = {
            showSplash: true,
            darkMode: false,
            currentView: 'home',
            items: [],
            trash: [],
            categories: ['Fruits & L√©gumes', 'Viande & Poisson', 'Produits laitiers', '√âpicerie', 'Hygi√®ne', 'Autres'],
            history: [],
            favorites: [],
            newItem: '',
            notifications: [],
            isListening: false,
            showCategoryModal: false,
            showEditItemModal: false,
            newCategory: '',
            shareCode: '',
            editingItem: null,
            isSyncing: false
        };

        // Item database for auto-categorization
        const itemsDB = {
            'Fruits & L√©gumes': ['tomate', 'pomme', 'banane', 'carotte', 'oignon', 'salade', 'courgette', 'citron', 'orange', 'fraise', 'avocat', 'pain des fleurs'],
            'Viande & Poisson': ['poulet', 'b≈ìuf', 'porc', 'saumon', 'thon', 'jambon', 'saucisse'],
            'Produits laitiers': ['lait', 'beurre', 'fromage', 'yaourt', 'cr√®me', '≈ìuf'],
            '√âpicerie': ['riz', 'p√¢tes', 'farine', 'sucre', 'sel', 'huile', 'pain', 'caf√©', 'th√©'],
            'Hygi√®ne': ['savon', 'shampoing', 'dentifrice', 'papier toilette']
        };

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Load saved data
        function loadData() {
            try {
                const saved = localStorage.getItem('smartListData');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.items = data.items || [];
                    state.trash = data.trash || [];
                    state.categories = data.categories || state.categories;
                    state.history = data.history || [];
                    state.favorites = data.favorites || [];
                    state.darkMode = data.darkMode || false;
                    state.shareCode = data.shareCode || '';
                }
            } catch (e) {
                console.error('Erreur chargement:', e);
            }
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem('smartListData', JSON.stringify({
                    items: state.items,
                    trash: state.trash,
                    categories: state.categories,
                    history: state.history,
                    favorites: state.favorites,
                    darkMode: state.darkMode,
                    shareCode: state.shareCode
                }));
            } catch (e) {
                console.error('Erreur sauvegarde:', e);
            }
        }

        // Auto-categorize item
        function getCategory(itemName) {
            const lower = itemName.toLowerCase();
            for (const [cat, keywords] of Object.entries(itemsDB)) {
                if (keywords.some(k => lower.includes(k) || k.includes(lower))) {
                    return cat;
                }
            }
            return 'Autres';
        }

        // Add item
        function addItem(name) {
            if (!name || !name.trim()) return;
            
            const item = {
                id: Date.now() + Math.random(),
                name: name.trim(),
                category: getCategory(name),
                completed: false,
                dateAdded: new Date().toISOString()
            };
            
            state.items.push(item);
            state.newItem = '';
            saveData();
            
            // Sync to Firebase if sharing
            if (currentListRef) {
                syncToFirebase();
            }
            
            showNotification(`"${escapeHtml(name)}" ajout√© dans ${item.category}`);
            render();
        }

        // Toggle item
        function toggleItem(id) {
            const item = state.items.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                saveData();
                
                // Sync to Firebase if sharing
                if (currentListRef) {
                    syncToFirebase();
                }
                
                render();
            }
        }

        // Toggle favorite
        function toggleFavorite(itemName) {
            const lowerName = itemName.toLowerCase();
            if (state.favorites.includes(lowerName)) {
                state.favorites = state.favorites.filter(f => f !== lowerName);
                showNotification(`"${escapeHtml(itemName)}" retir√© des favoris`);
            } else {
                state.favorites.push(lowerName);
                showNotification(`"${escapeHtml(itemName)}" ajout√© aux favoris`);
            }
            saveData();
            render();
        }

        // Remove item (move to trash)
        function removeItem(id) {
            const item = state.items.find(i => i.id === id);
            if (item) {
                state.trash.push({
                    ...item,
                    deletedAt: new Date().toISOString()
                });
                state.trash = state.trash.slice(-50);
                state.items = state.items.filter(i => i.id !== id);
                saveData();
                
                // Sync to Firebase if sharing
                if (currentListRef) {
                    syncToFirebase();
                }
                
                showNotification(`"${escapeHtml(item.name)}" dans la corbeille`);
                render();
            }
        }

        // Restore item from trash
        function restoreItem(id) {
            const item = state.trash.find(i => i.id === id);
            if (item) {
                const { deletedAt, ...restoredItem } = item;
                state.items.push(restoredItem);
                state.trash = state.trash.filter(i => i.id !== id);
                saveData();
                showNotification(`"${escapeHtml(item.name)}" restaur√©`);
                render();
            }
        }

        // Empty trash
        function emptyTrash() {
            if (state.trash.length === 0) {
                showNotification('La corbeille est vide');
                return;
            }
            if (confirm(`Vider d√©finitivement la corbeille (${state.trash.length} articles) ?`)) {
                state.trash = [];
                saveData();
                showNotification('Corbeille vid√©e');
                render();
            }
        }

        // Show notification
        function showNotification(message) {
            const notif = { id: Date.now(), message };
            state.notifications.push(notif);
            render();
            
            setTimeout(() => {
                state.notifications = state.notifications.filter(n => n.id !== notif.id);
                render();
            }, 3000);
        }

        // Toggle dark mode
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.className = state.darkMode ? 'dark' : '';
            saveData();
            render();
        }

        // Change view
        function changeView(view) {
            state.currentView = view;
            render();
        }

        // Save to history
        function saveToHistory() {
            if (state.items.length === 0) {
                showNotification('Aucun article √† sauvegarder');
                return;
            }
            
            const historyItem = {
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...state.items],
                total: state.items.length
            };
            
            state.history.unshift(historyItem);
            state.history = state.history.slice(0, 10);
            state.items = [];
            
            saveData();
            showNotification(`Liste sauvegard√©e dans l'historique (${historyItem.total} articles)`);
            render();
        }

        // Voice recognition
        let recognition = null;
        
        function initVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    if (text.toLowerCase().includes('ajouter') || text.toLowerCase().includes('ajoute')) {
                        const item = text.replace(/ajouter|ajoute/gi, '').trim();
                        if (item) addItem(item);
                    } else {
                        addItem(text);
                    }
                };
                
                recognition.onerror = (e) => {
                    console.error('Erreur reconnaissance:', e.error);
                    state.isListening = false;
                    if (e.error === 'not-allowed' || e.error === 'permission-denied') {
                        showNotification('Autorisez l\'acc√®s au microphone');
                    } else if (e.error === 'no-speech') {
                        showNotification('Aucune voix d√©tect√©e');
                    } else {
                        showNotification('Erreur microphone: ' + e.error);
                    }
                    render();
                };
                
                recognition.onend = () => {
                    state.isListening = false;
                    render();
                };
            }
        }

        function toggleListening() {
            if (!recognition) {
                showNotification('Reconnaissance vocale non disponible');
                return;
            }
            
            if (state.isListening) {
                try {
                    recognition.stop();
                    state.isListening = false;
                } catch (e) {
                    console.error('Erreur arr√™t:', e);
                }
            } else {
                try {
                    recognition.start();
                    state.isListening = true;
                    showNotification('Parlez maintenant...');
                } catch (e) {
                    console.error('Erreur d√©marrage:', e);
                    showNotification('Impossible de d√©marrer le microphone');
                    state.isListening = false;
                }
            }
            render();
        }

        // Open edit item modal
        function openEditItemModal(id) {
            state.editingItem = state.items.find(i => i.id === id);
            state.showEditItemModal = true;
            render();
        }

        // Update item
        function updateItem() {
            if (!state.editingItem) return;
            
            const nameInput = document.getElementById('editItemName');
            const categorySelect = document.getElementById('editItemCategory');
            
            if (!nameInput || !categorySelect) return;
            
            const item = state.items.find(i => i.id === state.editingItem.id);
            if (item) {
                item.name = nameInput.value.trim();
                item.category = categorySelect.value;
                saveData();
                
                // Sync to Firebase if sharing
                if (currentListRef) {
                    syncToFirebase();
                }
                
                showNotification('Article modifi√©');
            }
            
            state.showEditItemModal = false;
            state.editingItem = null;
            render();
        }

        // Add category
        function addNewCategory() {
            if (!state.newCategory.trim()) {
                showNotification('Entrez un nom de cat√©gorie');
                return;
            }
            
            if (state.categories.includes(state.newCategory.trim())) {
                showNotification('Cette cat√©gorie existe d√©j√†');
                return;
            }
            
            state.categories.push(state.newCategory.trim());
            state.newCategory = '';
            state.showCategoryModal = false;
            saveData();
            
            // Sync to Firebase if sharing
            if (currentListRef) {
                syncToFirebase();
            }
            
            showNotification('Cat√©gorie ajout√©e');
            render();
        }

        // Get time ago
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return '√† l\'instant';
            if (seconds < 3600) return `il y a ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `il y a ${Math.floor(seconds / 3600)} h`;
            if (seconds < 604800) return `il y a ${Math.floor(seconds / 86400)} j`;
            return date.toLocaleDateString('fr-FR');
        }

        // Render functions
        function renderHeader() {
            return `
                <div class="header">
                    <div class="header-top">
                        <div class="logo">
                            üõí SmartList
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-icon" onclick="toggleDarkMode()" style="background: #e5e7eb;">
                                ${state.darkMode ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                            <button class="btn btn-icon ${state.isListening ? 'btn-danger' : 'btn-primary'}" onclick="toggleListening()">
                                üé§
                            </button>
                        </div>
                    </div>
                    <div class="nav">
                        ${['home', 'trash', 'history', 'categories', 'favorites', 'share', 'settings'].map(view => `
                            <button class="nav-btn ${state.currentView === view ? 'active' : ''}" 
                                    onclick="changeView('${view}')">
                                ${getViewName(view)}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getViewName(view) {
            const names = {
                home: 'üè† Accueil',
                trash: 'üóëÔ∏è Corbeille',
                history: 'üìö Historique',
                categories: 'üè∑Ô∏è Cat√©gories',
                favorites: '‚≠ê Favoris',
                share: 'üîó Partager',
                settings: '‚öôÔ∏è Param√®tres'
            };
            return names[view] || view;
        }

        function renderHomeView() {
            const itemsByCategory = {};
            
            state.categories.forEach(cat => {
                itemsByCategory[cat] = [];
            });
            
            state.items.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory['Autres'] = itemsByCategory['Autres'] || [];
                    itemsByCategory['Autres'].push(item);
                } else {
                    itemsByCategory[item.category].push(item);
                }
            });

            return `
                <div class="card">
                    <div class="card-title">Ajouter un article</div>
                    <div class="input-group">
                        <input type="text" 
                               class="input" 
                               placeholder="Nom de l'article..." 
                               value="${state.newItem}"
                               onkeypress="if(event.key==='Enter')addItem(this.value)"
                               oninput="state.newItem=this.value">
                        <button class="btn btn-primary" onclick="addItem(state.newItem)">
                            ‚ûï
                        </button>
                    </div>
                    ${state.newItem ? `<div class="mt-2" style="font-size: 0.875rem; color: #6b7280;">
                        Cat√©gorie: ${getCategory(state.newItem)}
                    </div>` : ''}
                </div>

                <div class="card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="card-title" style="margin: 0;">
                            Ma liste (${state.items.filter(i => !i.completed).length}/${state.items.length})
                        </div>
                        ${state.items.length > 0 ? `
                            <button class="btn btn-success" onclick="saveToHistory()">
                                ‚úì Terminer
                            </button>
                        ` : ''}
                    </div>

                    ${state.items.length === 0 ? `
                        <div class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üõí</div>
                            <div style="font-size: 1.125rem; margin-bottom: 0.5rem;">Votre liste est vide</div>
                            <div style="font-size: 0.875rem;">Ajoutez des articles ou utilisez la commande vocale</div>
                        </div>
                    ` : `
                        ${state.categories.map(category => {
                            const items = itemsByCategory[category] || [];
                            if (items.length === 0) return '';
                            
                            return `
                                <div class="category-header">${escapeHtml(category)} (${items.length})</div>
                                ${items.map(item => `
                                    <div class="item ${item.completed ? 'completed' : ''}">
                                        <div class="checkbox ${item.completed ? 'checked' : ''}" 
                                             onclick="toggleItem(${item.id})">
                                            ${item.completed ? '‚úì' : ''}
                                        </div>
                                        <div class="item-name ${item.completed ? 'completed' : ''}" 
                                             onclick="openEditItemModal(${item.id})"
                                             style="cursor: pointer;">
                                            ${escapeHtml(item.name)}
                                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                                üìÅ ${escapeHtml(item.category)}
                                            </div>
                                        </div>
                                        <button class="btn btn-icon" 
                                                onclick="event.stopPropagation(); toggleFavorite('${escapeAttr(item.name)}')"
                                                style="width: 32px; height: 32px; background: none; border: none; cursor: pointer;">
                                            ${state.favorites.includes(item.name.toLowerCase()) ? '‚≠ê' : '‚òÜ'}
                                        </button>
                                        <button class="btn btn-icon btn-danger" 
                                                onclick="removeItem(${item.id})"
                                                style="width: 32px; height: 32px; font-size: 1rem;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                `).join('')}
                            `;
                        }).join('')}
                    `}
                </div>
            `;
        }

        function renderTrashView() {
            return `
                <div class="card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="card-title" style="margin: 0;">
                            Corbeille (${state.trash.length})
                        </div>
                        ${state.trash.length > 0 ? `
                            <button class="btn btn-danger" onclick="emptyTrash()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                üóëÔ∏è Vider
                            </button>
                        ` : ''}
                    </div>
                    
                    ${state.trash.length === 0 ? `
                        <div class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üóëÔ∏è</div>
                            <div style="font-size: 1.125rem; margin-bottom: 0.5rem;">Corbeille vide</div>
                            <div style="font-size: 0.875rem;">Les articles supprim√©s appara√Ætront ici</div>
                        </div>
                    ` : state.trash.map(item => `
                        <div class="item">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${escapeHtml(item.name)}</div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    üìÅ ${escapeHtml(item.category)} ‚Ä¢ Supprim√© ${getTimeAgo(item.deletedAt)}
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="restoreItem(${item.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                ‚Ü©Ô∏è Restaurer
                            </button>
                        </div>
                    `).join('')}
                    
                    ${state.trash.length > 0 ? `
                        <div class="mt-2" style="padding: 0.75rem; background: ${state.darkMode ? '#1e3a8a' : '#dbeafe'}; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem;">
                            ‚ÑπÔ∏è Les articles restent dans la corbeille jusqu'√† ce que vous la vidiez. Maximum 50 articles.
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderHistoryView() {
            return `
                <div class="card">
                    <div class="card-title">Historique des courses</div>
                    
                    ${state.history.length === 0 ? `
                        <div class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                            <div style="font-size: 1.125rem; margin-bottom: 0.5rem;">Aucun historique</div>
                            <div style="font-size: 0.875rem;">
                                Les listes termin√©es appara√Ætront ici.<br>
                                Cliquez sur "‚úì Terminer" dans l'accueil pour sauvegarder.
                            </div>
                        </div>
                    ` : state.history.map(record => `
                        <div style="padding: 1rem; background: ${state.darkMode ? '#374151' : '#f9fafb'}; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600;">
                                    ${new Date(record.date).toLocaleDateString('fr-FR', {
                                        weekday: 'short',
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </div>
                                <div style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: ${state.darkMode ? '#1f2937' : 'white'}; border-radius: 0.25rem;">
                                    ${record.total} articles
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                ${record.items.slice(0, 5).map(item => 
                                    `<div style="padding: 0.25rem 0;">‚Ä¢ ${escapeHtml(item.name)} <span style="opacity: 0.6;">(${escapeHtml(item.category)})</span></div>`
                                ).join('')}
                                ${record.items.length > 5 ? `<div style="padding: 0.25rem 0; font-style: italic;">... et ${record.items.length - 5} autres</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCategoriesView() {
            return `
                <div class="card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="card-title" style="margin: 0;">Cat√©gories</div>
                        <button class="btn btn-primary" onclick="state.showCategoryModal=true; render();">
                            ‚ûï Nouvelle
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        ${state.categories.map(cat => `
                            <div style="padding: 1rem; background: ${state.darkMode ? '#374151' : '#f9fafb'}; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üè∑Ô∏è</div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(cat)}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">
                                    ${state.items.filter(i => i.category === cat).length} articles
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2" style="padding: 1rem; background: ${state.darkMode ? '#065f46' : '#dcfce7'}; border-radius: 0.5rem; margin-top: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">üß† Classification automatique</div>
                        <div style="font-size: 0.875rem; color: ${state.darkMode ? '#d1fae5' : '#166534'};">
                            Les articles sont automatiquement class√©s dans la bonne cat√©gorie !
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFavoritesView() {
            return `
                <div class="card">
                    <div class="card-title">Articles favoris</div>
                    ${state.favorites.length === 0 ? `
                        <div class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚≠ê</div>
                            <div style="font-size: 1.125rem;">Aucun favori</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">
                                Ajoutez des articles fr√©quents √† vos favoris pour un acc√®s rapide
                            </div>
                        </div>
                    ` : state.favorites.map(fav => `
                        <div class="item">
                            <div style="flex: 1;">‚≠ê ${escapeHtml(fav)}</div>
                            <button class="btn btn-primary" onclick="addItem('${escapeAttr(fav)}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                + Ajouter
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderShareView() {
            return `
                <div class="card">
                    <div class="card-title">Partager ma liste en temps r√©el</div>
                    
                    ${!database ? `
                        <div style="padding: 1rem; background: ${state.darkMode ? '#7f1d1d' : '#fee2e2'}; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #991b1b;">‚ö†Ô∏è Mode d√©mo</div>
                            <div style="font-size: 0.875rem; color: #7f1d1d;">
                                Pour activer le partage en temps r√©el, configurez Firebase dans le code source.
                            </div>
                        </div>
                    ` : ''}
                    
                    <button class="btn btn-primary" onclick="generateShareCode()" style="width: 100%; margin-bottom: 1rem;" ${!database ? 'disabled' : ''}>
                        üîó G√©n√©rer un code de partage
                    </button>
                    
                    ${state.shareCode ? `
                        <div style="padding: 1rem; background: ${state.darkMode ? '#374151' : '#f3f4f6'}; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">Code de partage :</div>
                            <div style="font-size: 1.5rem; font-family: monospace; text-align: center; padding: 1rem; background: ${state.darkMode ? '#1f2937' : 'white'}; border-radius: 0.5rem; letter-spacing: 0.2rem;">
                                ${state.shareCode}
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; text-align: center;">
                                Partagez ce code pour collaborer sur cette liste
                            </div>
                            ${database ? `
                                <button class="btn btn-danger" onclick="stopSharing()" style="width: 100%; margin-top: 1rem; font-size: 0.875rem;">
                                    üîí Arr√™ter le partage
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <div style="border-top: 1px solid ${state.darkMode ? '#374151' : '#e5e7eb'}; padding-top: 1rem; margin-top: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Rejoindre une liste partag√©e</div>
                        <div class="input-group">
                            <input type="text" 
                                   class="input" 
                                   placeholder="Entrez un code..." 
                                   id="joinCode">
                            <button class="btn btn-success" onclick="joinSharedList()" ${!database ? 'disabled' : ''}>
                                Rejoindre
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 1rem; background: ${state.darkMode ? '#1e3a8a' : '#dbeafe'}; border-radius: 0.5rem; margin-top: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ú® Partage en temps r√©el</div>
                        <ul style="font-size: 0.875rem; color: ${state.darkMode ? '#bfdbfe' : '#1e40af'}; padding-left: 1.5rem;">
                            <li>G√©n√©rez un code unique pour votre liste</li>
                            <li>Partagez-le avec vos proches</li>
                            <li>Les modifications sont synchronis√©es instantan√©ment</li>
                            <li>Fonctionne sans installer l'application</li>
                            <li>Plusieurs personnes peuvent modifier en m√™me temps</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generateShareCode() {
            if (!database) {
                showNotification('Firebase non configur√© - Mode d√©mo uniquement');
                return;
            }
            
            // G√©n√©rer un code unique
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            state.shareCode = code;
            
            // Cr√©er la r√©f√©rence Firebase pour cette liste
            currentListRef = database.ref('lists/' + code);
            
            // Sauvegarder les donn√©es initiales
            currentListRef.set({
                items: state.items,
                categories: state.categories,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                // √âcouter les changements en temps r√©el
                setupRealtimeSync(code);
                saveData();
                showNotification(`Code de partage cr√©√©: ${code}`);
                render();
            }).catch(error => {
                console.error('Erreur cr√©ation liste:', error);
                showNotification('Erreur lors de la cr√©ation du partage');
            });
        }

        function setupRealtimeSync(code) {
            if (!database || !currentListRef) return;
            
            let isUpdatingFromRemote = false;
            
            // √âcouter les changements d'items
            currentListRef.child('items').on('value', (snapshot) => {
                const remoteItems = snapshot.val();
                if (remoteItems && !isUpdatingFromRemote) {
                    // Comparer pour √©viter les boucles infinies
                    const remoteStr = JSON.stringify(remoteItems);
                    const localStr = JSON.stringify(state.items);
                    
                    if (remoteStr !== localStr) {
                        isUpdatingFromRemote = true;
                        state.items = remoteItems;
                        saveData();
                        render();
                        setTimeout(() => { isUpdatingFromRemote = false; }, 100);
                    }
                }
            });
            
            // √âcouter les changements de cat√©gories
            currentListRef.child('categories').on('value', (snapshot) => {
                const remoteCategories = snapshot.val();
                if (remoteCategories && !isUpdatingFromRemote) {
                    const remoteStr = JSON.stringify(remoteCategories);
                    const localStr = JSON.stringify(state.categories);
                    
                    if (remoteStr !== localStr) {
                        isUpdatingFromRemote = true;
                        state.categories = remoteCategories;
                        saveData();
                        render();
                        setTimeout(() => { isUpdatingFromRemote = false; }, 100);
                    }
                }
            });
            
            console.log('Synchronisation en temps r√©el activ√©e pour:', code);
        }

        function syncToFirebase() {
            if (!database || !currentListRef) {
                console.warn('Firebase non disponible pour la synchronisation');
                return;
            }
            
            console.log('Synchronisation vers Firebase...');
            
            currentListRef.update({
                items: state.items,
                categories: state.categories,
                lastUpdate: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log('Synchronisation r√©ussie');
            }).catch(error => {
                console.error('Erreur sync:', error);
                showNotification('Erreur de synchronisation');
            });
        }

        function joinSharedList() {
            if (!database) {
                showNotification('Firebase non configur√© - Mode d√©mo uniquement');
                return;
            }
            
            const code = document.getElementById('joinCode')?.value.trim().toUpperCase();
            if (!code) {
                showNotification('Veuillez entrer un code');
                return;
            }
            
            const listRef = database.ref('lists/' + code);
            
            listRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const sharedData = snapshot.val();
                    
                    // Demander confirmation avant de remplacer
                    if (state.items.length > 0) {
                        if (!confirm('Voulez-vous remplacer votre liste actuelle par la liste partag√©e ?')) {
                            return;
                        }
                    }
                    
                    state.items = sharedData.items || [];
                    state.categories = sharedData.categories || state.categories;
                    state.shareCode = code;
                    currentListRef = listRef;
                    
                    setupRealtimeSync(code);
                    saveData();
                    showNotification(`Connect√© √† la liste ${code}`);
                    changeView('home');
                    render();
                } else {
                    showNotification('Code invalide ou liste expir√©e');
                }
            }).catch(error => {
                console.error('Erreur rejoindre liste:', error);
                showNotification('Erreur lors de la connexion');
            });
        }

        function stopSharing() {
            if (!currentListRef) return;
            
            if (confirm('Arr√™ter le partage de cette liste ?')) {
                currentListRef.off();
                currentListRef = null;
                state.shareCode = '';
                saveData();
                showNotification('Partage arr√™t√©');
                render();
            }
        }

        function renderSettingsView() {
            return `
                <div class="card">
                    <div class="card-title">Export / Import</div>
                    <button class="btn btn-primary" onclick="exportData()" style="width: 100%; margin-bottom: 0.5rem;">
                        üíæ Exporter la liste
                    </button>
                    <label class="btn btn-primary" style="width: 100%; display: block; text-align: center; cursor: pointer; margin-bottom: 1rem;">
                        üìÅ Importer une liste
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                    <div style="padding: 0.75rem; background: ${state.darkMode ? '#1e3a8a' : '#dbeafe'}; border-radius: 0.5rem; font-size: 0.875rem;">
                        ‚ÑπÔ∏è Export : T√©l√©charge vos donn√©es en JSON<br>
                        Import : Fusionne avec vos donn√©es existantes
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Mode sombre</div>
                    <div class="flex items-center justify-between">
                        <span>Th√®me sombre</span>
                        <button class="btn ${state.darkMode ? 'btn-primary' : ''}" 
                                onclick="toggleDarkMode()"
                                style="padding: 0.5rem 1rem;">
                            ${state.darkMode ? 'Activ√©' : 'D√©sactiv√©'}
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Debug & Maintenance</div>
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: ${state.darkMode ? '#374151' : '#f3f4f6'}; border-radius: 0.5rem; font-size: 0.875rem;">
                        <div><strong>Articles en m√©moire:</strong> ${state.items.length}</div>
                        <div><strong>Corbeille:</strong> ${state.trash.length} articles</div>
                        <div><strong>Cat√©gories:</strong> ${state.categories.length}</div>
                        <div><strong>Historique:</strong> ${state.history.length} listes</div>
                    </div>
                </div>
            `;
        }

        // Export/Import functions
        function exportData() {
            try {
                const dataToExport = {
                    items: state.items,
                    categories: state.categories,
                    favorites: state.favorites,
                    history: state.history,
                    exportDate: new Date().toISOString(),
                    appVersion: '1.0'
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `smartlist_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showNotification('Liste export√©e avec succ√®s');
            } catch (error) {
                console.error('Erreur export:', error);
                showNotification('Erreur lors de l\'export');
            }
        }

        function importData(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.items) {
                        state.items = [...state.items, ...importedData.items];
                    }
                    if (importedData.categories) {
                        state.categories = [...new Set([...state.categories, ...importedData.categories])];
                    }
                    if (importedData.favorites) {
                        state.favorites = [...new Set([...state.favorites, ...importedData.favorites])];
                    }
                    if (importedData.history) {
                        state.history = [...importedData.history, ...state.history];
                    }
                    
                    saveData();
                    showNotification('Liste import√©e avec succ√®s');
                    render();
                } catch (error) {
                    console.error('Erreur import:', error);
                    showNotification('Erreur lors de l\'importation');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function renderNotifications() {
            return state.notifications.map(n => `
                <div class="notification">${escapeHtml(n.message)}</div>
            `).join('');
        }

        function renderCategoryModal() {
            return `
                <div class="modal" onclick="if(event.target===this){state.showCategoryModal=false;render();}">
                    <div class="modal-content">
                        <div class="card-title">Nouvelle cat√©gorie</div>
                        <input type="text" 
                               class="input" 
                               placeholder="Nom de la cat√©gorie..."
                               value="${state.newCategory}"
                               oninput="state.newCategory=this.value"
                               onkeypress="if(event.key==='Enter')addNewCategory()"
                               style="margin-bottom: 1rem;">
                        <div class="flex gap-2">
                            <button class="btn" 
                                    onclick="state.showCategoryModal=false; state.newCategory=''; render();"
                                    style="flex: 1; background: #e5e7eb;">
                                Annuler
                            </button>
                            <button class="btn btn-primary" 
                                    onclick="addNewCategory()"
                                    style="flex: 1;">
                                Ajouter
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditItemModal() {
            if (!state.editingItem) return '';
            
            return `
                <div class="modal" onclick="if(event.target===this){state.showEditItemModal=false;state.editingItem=null;render();}">
                    <div class="modal-content">
                        <div class="card-title">Modifier l'article</div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nom:</label>
                            <input type="text" 
                                   id="editItemName"
                                   class="input" 
                                   value="${escapeAttr(state.editingItem.name)}"
                                   placeholder="Nom de l'article...">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cat√©gorie:</label>
                            <select id="editItemCategory" class="input">
                                ${state.categories.map(cat => `
                                    <option value="${escapeAttr(cat)}" ${state.editingItem.category === cat ? 'selected' : ''}>
                                        ${escapeHtml(cat)}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="btn" 
                                    onclick="state.showEditItemModal=false; state.editingItem=null; render();"
                                    style="flex: 1; background: #e5e7eb;">
                                Annuler
                            </button>
                            <button class="btn btn-primary" 
                                    onclick="updateItem()"
                                    style="flex: 1;">
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Main render
        function render() {
            const app = document.getElementById('app');
            
            if (state.showSplash) {
                app.innerHTML = `
                    <div class="splash">
                        <div class="splash-content">
                            <div class="splash-logo">üõí</div>
                            <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">SmartList</h1>
                            <p style="font-size: 1.125rem; opacity: 0.9;">Votre assistant courses intelligent</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let content = '';
            switch (state.currentView) {
                case 'home': content = renderHomeView(); break;
                case 'trash': content = renderTrashView(); break;
                case 'history': content = renderHistoryView(); break;
                case 'categories': content = renderCategoriesView(); break;
                case 'favorites': content = renderFavoritesView(); break;
                case 'share': content = renderShareView(); break;
                case 'settings': content = renderSettingsView(); break;
            }
            
            app.innerHTML = `
                ${renderHeader()}
                <div class="main">
                    ${content}
                </div>
                ${renderNotifications()}
                ${state.isListening ? '<div class="voice-indicator">üé§</div>' : ''}
                ${state.showCategoryModal ? renderCategoryModal() : ''}
                ${state.showEditItemModal ? renderEditItemModal() : ''}
            `;
        }

        // Initialize
        loadData();
        if (state.darkMode) document.body.className = 'dark';
        initVoice();
        render();

        setTimeout(() => {
            state.showSplash = false;
            render();
        }, 3000);
    </script>
</body>
</html>